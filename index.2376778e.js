const e=(e,i)=>t(e,i,"2d"),t=(e,t,r)=>{let a=i(t),l=document.createElement("canvas");t.appendChild(l),l.id=e,l.width=a.width,l.height=a.height;let s={context:l.getContext(r),canvas:l,resizeCallback:()=>{a=i(t),(l.width!==a.width||l.height!==a.height)&&(l.width=a.width,l.height=a.height)}};return s},i=e=>{let t={width:e.clientWidth,height:e.clientHeight};return t};class r{constructor(e){this.pipeline=[],this.canvasContext=e}addPipe(e){this.pipeline=this.pipeline.concat(e)}execute(e,t){let i={canvasContext:this.canvasContext,gameState:t};for(let t of this.pipeline)t.executeDelta(e,i)}}const a=(e,t=1/120,i=.1)=>{let r=new Date,a=!0,l=()=>{let t=new Date,s=(t.getTime()-r.getTime())/1e3;s=s>i?i:s,r=t,r=t,e(s),!0===a&&window.requestAnimationFrame(()=>{l()})};return window.requestAnimationFrame(()=>{l()}),()=>{a=!1}};class l{constructor(e=0,t=0,i=100,r=100,a=0,l=0,s=!0,o=1){this.x=this.xPrevious=e,this.y=this.yPrevious=t,this.width=i,this.height=r,this.vectorX=a,this.vectorY=l,this.obeysGravity=s,this.gravityScale=o}applyDelta(e,t){s(this,e,t)}createNewFromDelta(e,t){return o(this,e,t)}}const s=(e,t,i)=>{e.xPrevious=e.x,e.yPrevious=e.y,n(e,t,i),h(e,i)},o=(e,t,i)=>{let r=c(e);return s(r,t,i),r},h=(e,t)=>{e.x=e.x+e.vectorX*t,e.y=e.y+e.vectorY*t},n=(e,t,i)=>{e.obeysGravity&&(e.vectorY=Math.max(t.minVerticalVelocityPerSecond*e.gravityScale,e.vectorY+=t.gravityAccelerationPerSecond*i*e.gravityScale))},c=e=>({...e}),d=(e,t)=>({renderX:e.renderX,renderY:t.canvas.height-e.renderY-e.renderHeight}),p=(e,t)=>({renderX:e.renderX-t.x,renderY:e.renderY-t.y});class y extends l{constructor(e,t,i,r){super(e,t,i,r),this.colour="rgba(0, 0, 0, 0.3)",this.renderX=e,this.renderY=t,this.renderWidth=i,this.renderHeight=r}}const f=()=>{let e=[];for(let t=0;t<10;t++)e.push(u(t));let t=new y(3800,20,40,200);return t.colour="#3A980B",e.push(t),e},u=e=>{let t=new y(400*e,(e%3+3)*20,370,40);return t.colour="#3A980B",t},v=()=>new g({x:70,y:200,height:15,width:25},{x:20,y:200,height:20,width:35});class x extends y{constructor(e,t,i,r){super(e,t,i,r),this.positionHistory=[],this.onTheGround=!1,this.alive=!0,this.lastDelta=0}applyDelta(e,t){this.lastDelta=t,super.applyDelta(e,t)}}class w extends y{constructor(e,t,i,r){super(e,t,i,r),this.onTheGround=!1,this.alive=!0,this.positionHistory=[]}}class g{constructor(e,t){this.clicked=()=>{if(this.leader.onTheGround){if(this.leader.vectorX>0)this.leader.vectorY=300,this.leader.onTheGround=!1;else{this.leader.vectorX=400;let e=this.leader.x;for(;e>this.follower.x;)this.leader.positionHistory.unshift({x:e,y:this.leader.y}),e-=400*this.leader.lastDelta}}},this.leader=new x(e.x,e.y,e.width,e.height),this.follower=new w(t.x,t.y,t.width,t.height),this.vortex=new w(t.x+t.width/2,t.y,t.width/2,t.height),this.vortex.alive=!1}}const m=()=>({platforms:f(),player:v(),camera:{x:300,y:150},particles:[],snowClouds:[],snowFall:void 0,world:{gravity:900,minVerticalVelocityPerSecond:-900,gravityAccelerationPerSecond:-900}});class D extends y{constructor(e,t,i,r,a,l,s,o,h,n,c,d,p,y){super(e,t,i,r),this.alive=!0,this.renderX=e-this.renderWidth/2,this.renderY=t-this.renderHeight/2,this.originalRenderX=e,this.originalRenderY=t,this.renderWidth=i,this.renderHeight=r,this.vectorX=s,this.vectorY=o,this.lifeDelta=0,this.lifetimeInSeconds=y,this.initialWidth=i,this.initialHeight=r,this.finalWidth=a,this.finalHeight=l,this.opacity=h,this.initialOpacity=h,this.finalOpacity=n,this.red=c,this.green=d,this.blue=p}applyDelta(e,t){this.lifeDelta+=t,this.lifeDelta>this.lifetimeInSeconds&&(this.alive=!1),super.applyDelta(e,t),this.renderX=this.x,this.renderY=this.y;let i=this.lifeDelta/this.lifetimeInSeconds;this.width=this.renderWidth=this.initialWidth+(this.finalWidth-this.initialWidth)*i,this.height=this.renderHeight=this.initialHeight+(this.finalHeight-this.initialHeight)*i,this.obeysGravity||(this.renderX=this.originalRenderX-this.renderWidth/2,this.renderY=this.originalRenderY-this.renderHeight/2),this.opacity=this.initialOpacity+(this.finalOpacity-this.initialOpacity)*i,this.colour=`rgba(${this.red},${this.green},${this.blue},${this.opacity})`}}class P{constructor(e){this.particles=[],this.lastParticleDelta=0,this.nextParticleDueAt=0,this.createNewParticle=(e,t)=>{let i=t.x+3*e.canvas.width*Math.random(),r=e.canvas.height+10,a=5+5*Math.random(),l=new D(i,r,a,a,a,a,-30*Math.random(),-30*Math.random(),1,1,255,255,255,200);return l.gravityScale=.1+.3*Math.random(),l};for(let t=0;t<40;t++){let t=e.canvas.width*Math.random(),i=(e.canvas.height+150)*Math.random(),r=-30*Math.random(),a=-30*Math.random(),l=.1+.3*Math.random(),s=5+5*Math.random(),o=new D(t,i,s,s,s,s,r,a,1,1,255,255,255,200);o.gravityScale=l,this.particles.push(o)}}applyDelta(e,t,i,r){for(let i=this.particles.length-1;i>=0;i--){let r=this.particles[i];r.applyDelta(e,t),r.alive||this.particles.splice(i,1)}this.lastParticleDelta>=this.nextParticleDueAt&&(this.lastParticleDelta=0,this.nextParticleDueAt=.02*Math.random(),this.particles.push(this.createNewParticle(i,r))),this.particles.length>500&&this.particles.splice(0,this.particles.length-500),this.lastParticleDelta+=t}}class S{constructor(){this.xOffset=-200,this.yOffset=50,this.executeDelta=(e,t)=>{t.canvasContext;let i=t.gameState,r={x:i.player.leader.x+this.xOffset,y:this.yOffset};i.camera.x=r.x,i.camera.y=r.y}}}!function(e){e.Bottom="BOTTOM",e.Top="TOP",e.Left="LEFT",e.Right="RIGHT"}(j||(j={}));const C=(e,t,i,r,a,l,s,o)=>{let h=!1;return e<a+s&&e+i>a&&t<l+o&&t+r>l&&(h=!0),h},X=(e,t,i,r,a,l,s,o,h,n)=>{let c=i-e,d=r-t;if(0===c&&0===d)return null;if(0==c){let e=d>0?j.Bottom:j.Top;return e}if(0==d){let e=c>0?j.Left:j.Right;return e}if(c>0&&d<0){let l=e+a,h=i+a,{xFactor:c,offset:d}=Y(l,t,h,r),p=M(c,d,s),y=o+n<=p?j.Top:j.Left;return y}if(c<0&&d<0){let a=s+h,{xFactor:l,offset:c}=Y(e,t,i,r),d=M(l,c,a);return o+n<=d?j.Top:j.Right}if(c>0&&d>0){let h=e+a,n=t+l,c=i+a,d=r+l,{xFactor:p,offset:y}=Y(h,n,c,d),f=M(p,y,s),u=o>=f?j.Bottom:j.Left;return u}if(c<0&&d>0){let a=s+h,n=t+l,c=r+l,{xFactor:d,offset:p}=Y(e,n,i,c),y=M(d,p,a);return o>=y?j.Bottom:j.Right}return null},Y=(e,t,i,r)=>{let a=(r-t)/(i-e);return{xFactor:a,offset:t-a*e}},M=(e,t,i)=>t+i*e,H=j,T=(e,t)=>C(e.x,e.y,e.width,e.height,t.x,t.y,t.width,t.height),b=(e,t)=>{let i=!1;return!1===C(e.xPrevious,e.yPrevious,e.width,e.height,t.xPrevious,t.yPrevious,t.width,t.height)&&(i=C(e.x,e.y,e.width,e.height,t.x,t.y,t.width,t.height)),i},R=(e,t)=>X(e.xPrevious,e.yPrevious,e.x,e.y,e.width,e.height,t.x,t.y,t.width,t.height);class F{constructor(){this.executeDelta=(e,t)=>{t.canvasContext;let i=t.gameState;for(let e=0;e<i.platforms.length;e++){let t=i.platforms[e];T(i.player.leader,t)&&(console.log(R(i.player.leader,t)),i.player.leader.alive&&R(i.player.leader,t)!==H.Top?i.player.leader.alive=!1:R(i.player.leader,t)===H.Top&&(i.player.leader.onTheGround||(i.player.leader.onTheGround=!0),i.player.leader.y=t.y+t.height,i.player.leader.vectorY=0)),T(i.player.follower,t)&&(i.player.follower.alive&&R(i.player.follower,t)!==H.Top||R(i.player.follower,t)===H.Top&&(i.player.follower.onTheGround||(i.player.follower.onTheGround=!0),i.player.follower.y=t.y+t.height,i.player.follower.vectorY=0))}}}}class W{constructor(){this.executeDelta=(e,t)=>{t.canvasContext;let i=t.gameState;if(!i.player.leader.alive&&!i.player.follower.alive){i.player.vortex.alive=!1;return}if(i.player.leader.alive&&(i.player.leader.applyDelta(t.gameState.world,e),i.player.leader.renderX=i.player.leader.x,i.player.leader.renderY=i.player.leader.y),0==i.player.leader.vectorX)i.player.follower.applyDelta(t.gameState.world,e),i.player.follower.renderX=i.player.follower.x,i.player.follower.renderY=i.player.follower.y;else{let e=i.player.follower,r=i.player.leader,a=i.player.vortex;if(r.positionHistory.length>0){i.player.leader.alive&&r.positionHistory.push({x:r.x,y:r.y}),e.xPrevious=e.x,e.yPrevious=e.y;let t=r.positionHistory.shift();if(void 0!==t&&(r.alive?e.x=r.x-50:e.x=t.x,e.y=t.y,e.renderX=e.x,e.renderY=e.y,e.positionHistory.push(t)),i.player.follower.positionHistory.length>=i.player.leader.positionHistory.length/2&&(i.player.vortex.alive=!0),i.player.vortex.alive){let t=e.positionHistory.shift();void 0!==t&&(a.x=t.x,a.y=t.y,a.renderX=a.x,a.renderY=a.y)}}else e.alive=!1,t.snow={x:i.player.leader.x+i.player.leader.width/2,y:i.player.leader.y+i.player.leader.height/2}}}}}class G{constructor(){this.xVectorImpact=20,this.yVectorImpact=50,this.executeDelta=(e,t)=>{t.canvasContext;let i=t.gameState;if(i.player.vortex.alive&&i.snowFall)for(let e=0;e<i.snowFall.particles.length;e++){let t=i.snowFall.particles[e];T(i.player.leader,t)&&(t.vectorX+=Math.random()*this.xVectorImpact,t.vectorY+=Math.random()*this.yVectorImpact)}}}}class k{constructor(e,t){this.particles=[];for(let i=0;i<25;i++){let i=e-17.5+35*Math.random(),r=t-17.5+35*Math.random(),a=5+50*Math.random(),l=a/2.5,s=.2+.5*Math.random(),o=1+.5*Math.random(),h=100*Math.random()*i-17.5,n=100*Math.random()*r-17.5,c=new D(i,r,l,l,a,a,h,n,s,0,255,255,255,o);c.obeysGravity=!1,this.particles.push(c)}for(let i=0;i<45;i++){let i=e-17.5+35*Math.random(),r=t-17.5+35*Math.random(),a=5+5*Math.random(),l=-50+100*Math.random(),s=50+100*Math.random(),o=new D(i,r,a,a,a,a,l,s,1,1,255,255,255,30);o.gravityScale=.2,this.particles.push(o)}}applyDelta(e,t){for(let i=this.particles.length-1;i>=0;i--){let r=this.particles[i];r.applyDelta(e,t),r.alive||this.particles.splice(i,1)}}}class O{constructor(){this.executeDelta=(e,t)=>{t.canvasContext;let i=t.gameState;if(t.snow){let e=t.snow;i.snowClouds.push(new k(e.x,e.y))}for(let t=i.snowClouds.length-1;t>=0;t--){let r=i.snowClouds[0];if(r.particles.length>0){for(let t of(r.applyDelta(i.world,e),r.particles))if(t.obeysGravity){for(let e of i.platforms)if(T(t,e)){b(t,e)||(t.alive=!1);let i=R(t,e);i===H.Top?(t.vectorX=0,t.vectorY=0,t.y=e.y+e.height):i===H.Bottom?(t.vectorY=0,t.y=e.y-t.height):i===H.Right?(t.vectorX=0,t.x=e.x+e.width):(t.vectorX=0,t.x=e.x-t.width)}}}else i.snowClouds.splice(t,1)}}}}class V{constructor(){this.executeDelta=(e,t)=>{let i=t.canvasContext,r=t.gameState,a=r.snowFall;if(a&&a.particles.length>0){for(let t of(a.applyDelta(r.world,e,i,r.camera),a.particles))if(t.obeysGravity){for(let e of r.platforms)if(T(t,e)){b(t,e)||(t.alive=!1);let i=R(t,e);i===H.Top?(t.vectorX=0,t.vectorY=0,t.y=e.y+e.height):i===H.Bottom?(t.vectorY=0,t.y=e.y-t.height):i===H.Right?(t.vectorX=0,t.x=e.x+e.width):(t.vectorX=0,t.x=e.x-t.width)}}}}}}class I{constructor(e){this.executeDelta=(e,t)=>{let i=t.canvasContext;i.fillStyle=this.color,i.fillRect(0,0,i.canvas.width,i.canvas.height)},this.color=e}}class A{constructor(){this.executeDelta=(e,t)=>{let i=t.canvasContext,r=t.gameState;i.translate(-r.camera.x,-r.camera.y)}}}class B{constructor(){this.direction=1,this.x=130,this.minX=100,this.maxX=200,this.executeDelta=(e,t)=>{let i=t.canvasContext;i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,i.canvas.width,i.canvas.height)}}}class L{executeDelta(e,t){let i=t.canvasContext,r=t.gameState,a=r.camera;t.gameState.platforms.forEach(e=>{i.fillStyle=e.colour;let t=p(d(e,i),a);i.fillRect(t.renderX,t.renderY,e.width,e.height)})}}class E{executeDelta(e,t){let i=t.canvasContext;i.fillStyle="#D10000";let r=t.gameState,a=r.camera;if(!r.player.leader.alive&&!r.player.follower.alive)return;let l=$(r.player.leader.vectorY,Math.abs(r.world.minVerticalVelocityPerSecond));l*=r.player.leader.vectorX/400,z(r.player.leader,l,i,a);let s=$((r.player.follower.y-r.player.follower.yPrevious)/e,Math.abs(r.world.minVerticalVelocityPerSecond)),o=(r.player.follower.x-r.player.follower.xPrevious)/e;s*=o/400,z(r.player.follower,s,i,a),i.fillStyle="rgba(255,0,0,0.3)"}}const z=(e,t,i,r)=>{let a=p(d(e,i),r);i.save(),i.translate(a.renderX+e.renderWidth/2,a.renderY+e.renderHeight/2),i.rotate((360-t)*Math.PI/180),i.fillRect(-e.renderWidth/2,-e.renderHeight/2,e.renderWidth,e.renderHeight),i.restore()},$=(e,t)=>90*(e/t);class N{executeDelta(e,t){let i=t.canvasContext,r=t.gameState,a=r.camera;for(let e of r.snowClouds)for(let t of e.particles){let e=p(d(t,i),a);i.fillStyle=t.colour,i.fillRect(e.renderX,e.renderY,t.renderWidth,t.renderHeight)}}}class q{executeDelta(e,t){let i=t.canvasContext,r=t.gameState,a=r.camera,l=r.snowFall;if(l)for(let e of l.particles){let t=p(d(e,i),a);i.fillStyle=e.colour,i.fillRect(t.renderX,t.renderY,e.renderWidth,e.renderHeight)}}}class U{constructor(e,t){this.stop=()=>{this.runnerStopCallback()},this.step=e=>{this.resizeCallback(),this.pipeline.execute(e,this.gameState)},this.bindUICapture=()=>{document.body.addEventListener("click",this.userClicked,!0),document.body.addEventListener("touchstart",this.userClicked,!0)},this.userClicked=()=>{this.gameState.player.clicked()},this.canvasContext=e,this.resizeCallback=t,this.pipeline=new r(this.canvasContext),this.setup()}setup(){this.gameState=m(),this.gameState.snowFall=new P(this.canvasContext),this.pipeline.addPipe(new W),this.pipeline.addPipe(new F),this.pipeline.addPipe(new O),this.pipeline.addPipe(new V),this.pipeline.addPipe(new G),this.pipeline.addPipe(new S),this.pipeline.addPipe(new A),this.pipeline.addPipe(new B),this.pipeline.addPipe(new I("#1e2640")),this.pipeline.addPipe(new L),this.pipeline.addPipe(new E),this.pipeline.addPipe(new N),this.pipeline.addPipe(new q),this.bindUICapture(),this.runnerStopCallback=a(this.step,25)}}var j,J=(e,t)=>{new U(e,t)};(()=>{let t=document.body,{canvas:i,context:r,resizeCallback:a}=e("game-canvas",t);a(),J(r,a)})();